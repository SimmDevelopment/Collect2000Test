SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[SP_StatusChange3]      /*Changes Status from a Closed Type to an Active Type whether the account is Returned or not and updates DeskInventory Stats */    @FileNumber int,    @Status varchar (3),    @QDate varchar (10),    @ReturnSts bit output  AS    DECLARE @Balance money    DECLARE @Desk varchar (7)    DECLARE @Cust varchar (7)    DECLARE @TheMonth int    DECLARE @TheYear int    DECLARE @NumberIn int    DECLARE @AmtIn money BEGIN TRANSACTION    SELECT @Balance=current0, @Desk=Desk, @Cust=Customer FROM master where number = @FileNumber    /*Make sure the Desk still exists*/    SELECT * from Desk where code = @Desk    IF @@rowcount = 0 BEGIN        goto ReturnError    END    ELSE BEGIN        SELECT @TheMonth=currentmonth, @TheYear=currentyear FROM controlFile        /*Update DeskInventoryStats*/        SELECT @NumberIn=OtherNumberIn, @AmtIn=OtherAmtIn FROM DeskInventoryStats WHERE Desk = @Desk and customer = @Cust and SysYear = @TheYear and SysMonth = @TheMonth        IF (@@RowCount = 0)  BEGIN            INSERT INTO DeskInventoryStats (desk, SysYear, SysMonth, customer, OtherNumberIn, OtherAmtIn)            VALUES (@Desk, @TheYear, @TheMonth, @Cust, 1, @Balance)        END        ELSE BEGIN            UPDATE DeskInventoryStats SET OtherNumberIn = @NumberIn + 1, OtherAmtIn = @AmtIn + @Balance             WHERE Desk = @Desk and customer = @Cust and SysYear = @TheYear and SysMonth = @TheMonth        END        /*Update master*/        UPDATE master set status = @status, Qlevel = '100', QDate = @QDate, closed = NULL, returned = NULL  WHERE number = @FileNumber    END     IF (@@error <> 0) BEGIN    goto ReturnError END ELSE BEGIN    COMMIT TRAN    set @ReturnSts = 1 END ReturnError:    ROLLBACK TRAN    Set @ReturnSts = 0 
GO
